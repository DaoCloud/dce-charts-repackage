apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gateway-api-inference-extension.name" . }}
  namespace: {{ .Release.Namespace }}
data:
  default-plugins.yaml: |
    apiVersion: inference.networking.x-k8s.io/v1alpha1
    kind: EndpointPickerConfig
    plugins:
    - type: queue-scorer
    - type: kv-cache-utilization-scorer
    - type: prefix-cache-scorer
    {{- if .Values.inferenceExtension.latencyPredictor.enabled }}
    - type: predicted-latency-scorer
      parameters:
        {{- with .Values.inferenceExtension.latencyPredictor.sloAwareRouting | default dict }}
        samplingMean: {{ .samplingMean | default 1000.0 }}
        maxSampledTokens: {{ .maxSampledTokens | default 20 }}
        sloBufferFactor: {{ .sloBufferFactor | default 1.0 }}
        negHeadroomTTFTWeight: {{ .negHeadroomTTFTWeight | default 0.8 }}
        negHeadroomTPOTWeight: {{ .negHeadroomTPOTWeight | default 0.2 }}
        headroomTTFTWeight: {{ .headroomTTFTWeight | default 0.8 }}
        headroomTPOTWeight: {{ .headroomTPOTWeight | default 0.2 }}
        headroomSelectionStrategy: {{ .headroomSelectionStrategy | default "least" | quote }}
        compositeKVWeight: {{ .compositeKVWeight | default 1.0 }}
        compositeQueueWeight: {{ .compositeQueueWeight | default 1.0 }}
        compositePrefixWeight: {{ .compositePrefixWeight | default 1.0 }}
        epsilonExploreSticky: {{ .epsilonExploreSticky | default 0.01 }}
        epsilonExploreNeg: {{ .epsilonExploreNeg | default 0.01 }}
        affinityGateTau: {{ .affinityGateTau | default 0.80 }}
        affinityGateTauGlobal: {{ .affinityGateTauGlobal | default 0.99 }}
        selectionMode: {{ .selectionMode | default "linear" | quote }}
        {{- end }}
    {{- end }}
    schedulingProfiles:
    {{- if .Values.inferenceExtension.latencyPredictor.enabled }}
    - name: default
      plugins:
      - pluginRef: predicted-latency-scorer
    featureGates:
      - prepareDataPlugins
    {{- else }}
    - name: default
      plugins:
      - pluginRef: queue-scorer
        weight: 2
      - pluginRef: kv-cache-utilization-scorer
        weight: 2
      - pluginRef: prefix-cache-scorer
        weight: 3
    {{- end }}
  {{- if (hasKey .Values.inferenceExtension "pluginsCustomConfig") }}
  {{- .Values.inferenceExtension.pluginsCustomConfig | toYaml | nindent 2 }}
  {{- end }}
  
---
{{- if and .Values.inferenceExtension.sidecar.enabled .Values.inferenceExtension.sidecar.configMapData }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gateway-api-inference-extension.name" . }}-sidecar
  namespace: {{ .Release.Namespace }}
data:
  {{- .Values.inferenceExtension.sidecar.configMapData | toYaml | nindent 2 }}
{{- end }}
---
{{- if .Values.inferenceExtension.latencyPredictor.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gateway-api-inference-extension.name" . }}-latency-predictor-training
  namespace: {{ .Release.Namespace }}
data:
  {{- range $key, $value := .Values.inferenceExtension.latencyPredictor.trainingServer.config }}
  {{ $key }}: {{ $value | quote }}
{{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gateway-api-inference-extension.name" . }}-latency-predictor-prediction
  namespace: {{ .Release.Namespace }}
data:
  {{- range $key, $value := .Values.inferenceExtension.latencyPredictor.predictionServers.config }}
  {{ $key }}: {{ $value | quote }}
  {{- end }}
{{- end }}
